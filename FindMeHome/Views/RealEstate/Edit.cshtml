@model FindMeHome.Dtos.CreateRealEstateDto
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResource> Localizer
@{
    ViewData["Title"] = Localizer["EditPropertyTitle"];
    var existingImages = ViewBag.ExistingImages as List<FindMeHome.Dtos.RealEstateImageDto>;
}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<div class="container py-5"
    dir="@(System.Globalization.CultureInfo.CurrentCulture.TextInfo.IsRightToLeft ? "rtl" : "ltr")">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="card-header bg-gradient-primary text-white text-center py-4 border-0"
                    style="background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);">
                    <h3 class="mb-1 fw-bold"><i class="fa-solid fa-pen-to-square me-2"></i>
                        @Localizer["EditPropertyTitle"]</h3>
                    <p class="mb-0 opacity-75">@Localizer["EditPropertySubtitle"]</p>
                </div>

                <div class="card-body p-5 bg-light">
                    <form asp-action="Edit" asp-controller="RealEstate" asp-route-id="@ViewBag.Id" method="post"
                        enctype="multipart/form-data" id="editForm">

                        <!-- Basic Info Section -->
                        <div class="bg-white p-4 rounded-4 shadow-sm mb-4">
                            <h5 class="fw-bold text-primary mb-4 border-bottom pb-2"><i
                                    class="fa-solid fa-circle-info me-2"></i> @Localizer["BasicInfo"]</h5>
                            <div class="row g-4">
                                <div class="col-md-12">
                                    <label class="form-label fw-bold text-muted">@Localizer["AdTitle"]</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0"><i
                                                class="fa-solid fa-heading text-primary"></i></span>
                                        <input asp-for="Title" class="form-control bg-light border-0 py-2"
                                            placeholder="@Localizer["AdTitlePlaceholder"]" required />
                                    </div>
                                    <span asp-validation-for="Title" class="text-danger small"></span>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-muted">@Localizer["Price"]</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0"><i
                                                class="fa-solid fa-money-bill-wave text-success"></i></span>
                                        <input asp-for="Price" type="number" class="form-control bg-light border-0 py-2"
                                            value="@Model.Price.ToString("G0")" placeholder="0" step="1" min="1" required />
                                    </div>
                                    <span asp-validation-for="Price" class="text-danger small"></span>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-muted">@Localizer["Area"]</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0"><i
                                                class="fa-solid fa-ruler-combined text-warning"></i></span>
                                        <input asp-for="Area" type="number" class="form-control bg-light border-0 py-2"
                                            placeholder="0" step="0.01" min="1" required />
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-muted">@Localizer["OfferType"]</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0"><i
                                                class="fa-solid fa-tag text-info"></i></span>
                                        <select asp-for="ApartmentType" class="form-select bg-light border-0 py-2"
                                            required>
                                            <option value="">@Localizer["SelectOption"]</option>
                                            <option value="ForSale">@Localizer["ForSale"]</option>
                                            <option value="ForRent">@Localizer["ForRent"]</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-muted">@Localizer["UnitType"]</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0"><i
                                                class="fa-solid fa-building text-secondary"></i></span>
                                        <select asp-for="UnitType" class="form-select bg-light border-0 py-2" required>
                                            <option value="">@Localizer["SelectOption"]</option>
                                            <option value="Residential">@Localizer["Residential"]</option>
                                            <option value="Commercial">@Localizer["Commercial"]</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Details Section -->
                        <div class="bg-white p-4 rounded-4 shadow-sm mb-4">
                            <h5 class="fw-bold text-primary mb-4 border-bottom pb-2"><i
                                    class="fa-solid fa-list-check me-2"></i> @Localizer["DetailsAndSpecs"]</h5>
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-muted">@Localizer["NumberOfRooms"]</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0"><i
                                                class="fa-solid fa-bed text-primary"></i></span>
                                        <input asp-for="Rooms" type="number" class="form-control bg-light border-0 py-2"
                                            min="1" required />
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-muted">@Localizer["NumberOfBathrooms"]</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0"><i
                                                class="fa-solid fa-bath text-info"></i></span>
                                        <input asp-for="Bathrooms" type="number"
                                            class="form-control bg-light border-0 py-2" min="1" required />
                                    </div>
                                </div>

                                <div class="col-12">
                                    <label
                                        class="form-label fw-bold text-muted">@Localizer["PropertyDescription"]</label>
                                    <textarea asp-for="Description" class="form-control bg-light border-0 rounded-3"
                                        rows="4" placeholder="@Localizer["DescriptionPlaceholder"]"></textarea>
                                </div>

                                <div class="col-12">
                                    <div
                                        class="form-check form-switch p-0 d-flex align-items-center gap-3 bg-light p-3 rounded-3">
                                        <input asp-for="CanBeFurnished" class="form-check-input ms-0" type="checkbox"
                                            style="width: 3em; height: 1.5em;" />
                                        <div>
                                            <label class="form-check-label fw-bold mb-0"
                                                for="CanBeFurnished">@Localizer["FurnishedCheckbox"]</label>
                                            <small class="d-block text-muted">@Localizer["FurnishedHint"]</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Location Section -->
                        <div class="bg-white p-4 rounded-4 shadow-sm mb-4">
                            <h5 class="fw-bold text-primary mb-4 border-bottom pb-2"><i
                                    class="fa-solid fa-map-location-dot me-2"></i> @Localizer["LocationAndAddress"]</h5>
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-muted">@Localizer["City"]</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0"><i
                                                class="fa-solid fa-city text-secondary"></i></span>
                                        <input asp-for="City" class="form-control bg-light border-0 py-2"
                                            placeholder="@Localizer["City"]" required />
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-muted">@Localizer["Neighborhood"]</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0"><i
                                                class="fa-solid fa-map-pin text-danger"></i></span>
                                        <input asp-for="Neighborhood" class="form-control bg-light border-0 py-2"
                                            placeholder="@Localizer["Neighborhood"]" required />
                                    </div>
                                </div>

                                <div class="col-12">
                                    <label class="form-label fw-bold text-muted">@Localizer["DetailedAddress"]</label>
                                    <input asp-for="Address" class="form-control bg-light border-0 py-2"
                                        placeholder="@Localizer["AddressPlaceholder"]" required />
                                </div>

                                <div class="col-12">
                                    <label class="form-label fw-bold text-muted">@Localizer["MapLocation"]</label>
                                    <div class="card border-0 shadow-sm">
                                        <div id="map" style="height: 350px; border-radius: 12px; z-index: 1;"></div>
                                    </div>
                                    <input type="text" id="LocationAddress" name="LocationAddress"
                                        class="form-control mt-2 bg-light border-0 small text-muted" readonly
                                        placeholder="@Localizer["MapPlaceholder"]" />
                                    <input type="hidden" id="Latitude" name="Latitude" />
                                    <input type="hidden" id="Longitude" name="Longitude" />
                                </div>
                            </div>
                        </div>

                        <!-- Contact & Media Section -->
                        <div class="bg-white p-4 rounded-4 shadow-sm mb-4">
                            <h5 class="fw-bold text-primary mb-4 border-bottom pb-2"><i
                                    class="fa-solid fa-images me-2"></i> @Localizer["ImagesAndContact"]</h5>
                            <div class="row g-4">
                                <div class="col-md-12">
                                    <label class="form-label fw-bold text-muted">@Localizer["WhatsAppNumber"]</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0"><i
                                                class="fa-brands fa-whatsapp text-success fs-5"></i></span>
                                        <input asp-for="WhatsAppNumber" type="tel"
                                            class="form-control bg-light border-0 py-2" placeholder="201xxxxxxxxx"
                                            required />
                                    </div>
                                </div>

                                <div class="col-12">
                                    <label class="form-label fw-bold text-muted">@Localizer["PropertyImages"]</label>

                                    <!-- Existing Images -->
                                    @if (existingImages != null && existingImages.Any())
                                    {
                                        <div class="mb-3">
                                            <h6 class="text-muted small">@Localizer["CurrentImages"]</h6>
                                            <div class="d-flex flex-wrap gap-2">
                                                @foreach (var img in existingImages)
                                                {
                                                    <img src="@img.ImageUrl" class="rounded-3 shadow-sm object-fit-cover"
                                                        style="width: 100px; height: 100px;">
                                                }
                                            </div>
                                        </div>
                                    }

                                    <div class="upload-box border-2 border-dashed rounded-4 p-5 text-center bg-light position-relative overflow-hidden transition-all"
                                        style="cursor:pointer; border-color: #dee2e6;">
                                        <div class="content">
                                            <i class="fa-solid fa-cloud-arrow-up fs-1 text-primary mb-3"></i>
                                            <h6 class="fw-bold mb-1">@Localizer["UploadNewImages"]</h6>
                                            <p class="text-muted small mb-0">@Localizer["DragDropImages"]</p>
                                        </div>
                                        <input type="file" name="Images" multiple
                                            class="form-control position-absolute top-0 start-0 w-100 h-100 opacity-0"
                                            id="propertyImages" style="cursor:pointer;" />
                                    </div>
                                    <div id="previewContainer"
                                        class="d-flex flex-wrap justify-content-center mt-3 gap-3"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="d-flex gap-3 justify-content-center mt-5">
                            <button type="submit"
                                class="btn btn-primary btn-lg px-5 rounded-pill fw-bold shadow hover-scale">
                                <i class="fa-solid fa-save me-2"></i> @Localizer["SaveChanges"]
                            </button>
                            <a asp-action="MyProperties" asp-controller="RealEstate"
                                class="btn btn-light btn-lg px-5 rounded-pill fw-bold shadow-sm hover-scale">
                                <i class="fa-solid fa-xmark me-2"></i> @Localizer["Cancel"]
                            </a>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .border-dashed {
        border-style: dashed !important;
    }

    .hover-scale {
        transition: transform 0.2s ease;
    }

    .hover-scale:hover {
        transform: scale(1.05);
    }

    .upload-box:hover {
        background-color: #e9ecef !important;
        border-color: #0d6efd !important;
    }

    .form-control:focus,
    .form-select:focus {
        box-shadow: none;
        border: 2px solid #86b7fe !important;
        background-color: #fff !important;
    }
</style>

<!-- Map Script -->
<script>
    var map = L.map('map').setView([30.0444, 31.2357], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    var marker = L.marker([30.0444, 31.2357], { draggable: true }).addTo(map);

    function updateLocation(lat, lon) {
        document.getElementById("Latitude").value = lat;
        document.getElementById("Longitude").value = lon;

        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ar`)
            .then(res => res.json())
            .then(data => {
                document.getElementById("LocationAddress").value = data.display_name || "عنوان غير معروف";
            })
            .catch(() => {
                document.getElementById("LocationAddress").value = "حدث خطأ أثناء تحديد العنوان";
            });
    }

    map.on('click', function (e) {
        marker.setLatLng(e.latlng);
        updateLocation(e.latlng.lat, e.latlng.lng);
    });

    marker.on('dragend', function (e) {
        var latlng = e.target.getLatLng();
        updateLocation(latlng.lat, latlng.lng);
    });
</script>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function () {
            // Form Submit Logic
            $("#editForm").on("submit", function (e) {
                e.preventDefault();
                const form = $(this);
                const formData = new FormData(this);

                $.ajax({
                    url: form.attr("action"),
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    beforeSend: function () {
                        Swal.fire({
                            title: "جارٍ الحفظ...",
                            text: "يرجى الانتظار",
                            allowOutsideClick: false,
                            didOpen: () => Swal.showLoading()
                        });
                    },
                    success: function (response) {
                        if (response.isSuccess) {
                            Swal.fire({
                                icon: "success",
                                title: "تم الحفظ بنجاح!",
                                text: response.message,
                                confirmButtonText: "حسناً"
                            }).then(() => window.location.href = "/RealEstate/MyProperties");
                        } else {
                            Swal.fire({ icon: "error", title: "خطأ", text: response.message });
                        }
                    },
                    error: function () {
                        Swal.fire({ icon: "error", title: "خطأ", text: "حدث خطأ في الاتصال بالخادم" });
                    }
                });
            });

            // Image Preview
            $("#propertyImages").change(function () {
                const container = $("#previewContainer");
                container.empty();
                [...this.files].forEach(file => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        container.append(`<img src="${e.target.result}" class="rounded-3 shadow-sm object-fit-cover" style="width: 100px; height: 100px;">`);
                    };
                    reader.readAsDataURL(file);
                });
            });
        });
    </script>
    @await Html.PartialAsync("_ValidationScriptsPartial")
}
