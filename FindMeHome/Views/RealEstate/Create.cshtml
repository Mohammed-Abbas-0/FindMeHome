@model FindMeHome.Dtos.CreateRealEstateDto
@{
    ViewData["Title"] = "إضافة عقار جديد";
}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<div class="container mt-5 mb-5" dir="rtl">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white text-center py-3 rounded-top">
            <h4 class="mb-0">🏠 إضافة عقار جديد</h4>
        </div>

        <div class="card-body p-4">
            <form asp-action="Create" asp-controller="RealEstate" method="post" enctype="multipart/form-data">
                <div class="row g-3">

                    <!-- العنوان -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">عنوان العقار</label>
                        <input name="Title" class="form-control" placeholder="مثلاً شقة مميزة بالتجمع الخامس" required />
                        <span asp-validation-for="Title" class="text-danger"></span>
                    </div>

                    <!-- السعر -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">السعر</label>
                        <input type="number" name="Price" class="form-control" placeholder="مثلاً 850000" step="0.01" min="1" required />
                        <span asp-validation-for="Price" class="text-danger"></span>
                    </div>

                    <!-- المدينة -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">المدينة</label>
                        <input name="City" class="form-control" placeholder="مثلاً القاهرة" required />
                    </div>

                    <!-- العنوان -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">العنوان بالتفصيل</label>
                        <input name="Address" class="form-control" placeholder="مثلاً شارع التسعين الجنوبي" required />
                    </div>

                    <!-- المساحة -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">المساحة (م²)</label>
                        <input type="number" name="Area" class="form-control" placeholder="مثلاً 120" step="0.01" min="1" required />
                    </div>

                    <!-- نوع العقار -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">نوع العرض</label>
                        <select name="ApartmentType" class="form-select" required>
                            <option value="">-- اختر نوع العرض --</option>
                            <option value="ForSale">للبيع</option>
                            <option value="ForRent">للإيجار</option>
                        </select>
                    </div>

                    <!-- هل مفروش -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">هل العقار متاح للبيع مفروش؟</label>
                        <div class="form-check">
                            <input id="CanBeFurnished" name="CanBeFurnished" class="form-check-input" type="checkbox" value="true" />
                            <label class="form-check-label">نعم، العقار متاح للبيع مفروش مع إمكانية إضافة أثاث إضافي</label>
                        </div>
                        <small class="text-muted">إذا قمت بتحديد هذا الخيار، يمكنك إضافة قطع الأثاث المتاحة للبيع مع العقار</small>
                    </div>

                    <!-- نوع الوحدة -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">نوع الوحدة</label>
                        <select name="UnitType" class="form-select" required>
                            <option value="">-- اختر نوع الوحدة --</option>
                            <option value="Residential">سكني</option>
                            <option value="Commercial">تجاري</option>
                        </select>
                    </div>

                    <!-- رقم الواتساب -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">📱 رقم الواتساب</label>
                        <input type="tel" name="WhatsAppNumber" class="form-control" placeholder="مثلاً +201234567890" required />
                        <small class="text-muted">رقم الواتساب للتواصل مع المشترين</small>
                    </div>

                    <!-- الوصف -->
                    <div class="col-md-12">
                        <label class="form-label fw-bold">الوصف</label>
                        <textarea name="Description" class="form-control" rows="3" placeholder="وصف تفصيلي للعقار..."></textarea>
                    </div>

                    <!-- عدد الغرف -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">عدد الغرف</label>
                        <input type="number" name="Rooms" class="form-control" min="1" value="1" required />
                    </div>

                    <!-- عدد الحمامات -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">عدد الحمامات</label>
                        <input type="number" name="Bathrooms" class="form-control" min="1" value="1" required />
                    </div>

                    <!-- المنطقة -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">المنطقة</label>
                        <input type="text" name="Neighborhood" class="form-control" placeholder="مثلاً التجمع الخامس" required />
                    </div>

                    <!-- 🪑 قسم الأثاث -->
                    <div id="furnitureSection" class="col-12 mt-4" style="display:none;">
                        <div class="card shadow-sm border-primary">
                            <div class="card-header bg-primary text-white">
                                <h5 class="fw-bold mb-0">🪑 إضافة الأثاث المتاح للبيع</h5>
                                <small>يمكنك إضافة قطع الأثاث المتاحة للبيع مع العقار، وسيظهر للمشتري الخيار لإضافتها للسعر الأساسي</small>
                            </div>
                            <div class="card-body">
                                <div id="furnitureList">
                                    <!-- سيتم إضافة قطع الأثاث هنا ديناميكياً -->
                                </div>
                                <div class="text-end mt-3">
                                    <button type="button" id="addFurnitureBtn" class="btn btn-outline-primary">
                                        <i class="bi bi-plus-circle"></i> إضافة قطعة أثاث
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 🗺️ موقع العقار -->
                    <div class="col-12 mt-4">
                        <label class="form-label fw-bold">📍 موقع العقار</label>
                        <div class="card shadow-sm border-0 p-3 bg-light">
                            <div id="map" style="height: 300px; border-radius: 12px; overflow: hidden;"></div>
                            <small class="text-muted">اضغط على الخريطة لتحديد الموقع بدقة.</small>
                        </div>
                    </div>

                    <!-- العنوان الناتج -->
                    <div class="col-md-12 mt-3">
                        <label class="form-label fw-bold">📌 العنوان الناتج من الخريطة</label>
                        <input type="text" id="LocationAddress" name="LocationAddress" class="form-control" readonly placeholder="سيظهر العنوان هنا بعد اختيار الموقع..." />
                    </div>

                    <!-- الإحداثيات -->
                    <input type="hidden" id="Latitude" name="Latitude" />
                    <input type="hidden" id="Longitude" name="Longitude" />

                    <!-- صور العقار -->
                    <div class="col-md-12 mt-4">
                        <label class="form-label fw-bold">📸 صور العقار</label>
                        <div class="upload-box border rounded-3 p-4 text-center bg-light" style="cursor:pointer;">
                            <i class="bi bi-cloud-upload fs-2 text-primary"></i>
                            <p class="mb-2">اضغط هنا لاختيار الصور أو اسحبها هنا</p>
                            <input type="file" name="Images" multiple class="form-control d-none" id="propertyImages" />
                            <div id="previewContainer" class="d-flex flex-wrap justify-content-center mt-3 gap-2"></div>
                        </div>
                    </div>

                    <!-- زر الحفظ -->
                    <div class="col-12 text-center mt-4">
                        <button type="submit" class="btn btn-success px-5 py-2 fw-bold">💾 حفظ العقار</button>
                        <a asp-action="Index" asp-controller="RealEstate" class="btn btn-outline-secondary px-4 py-2 ms-2">↩️ رجوع</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 🌍 خريطة جوجل -->
<script>
    var map = L.map('map').setView([30.0444, 31.2357], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    var marker = L.marker([30.0444, 31.2357], { draggable: true }).addTo(map);

    function updateLocation(lat, lon) {
        document.getElementById("Latitude").value = lat;
        document.getElementById("Longitude").value = lon;

        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ar`)
            .then(res => res.json())
            .then(data => {
                document.getElementById("LocationAddress").value = data.display_name || "عنوان غير معروف";
            })
            .catch(() => {
                document.getElementById("LocationAddress").value = "حدث خطأ أثناء تحديد العنوان";
            });
    }

    map.on('click', function (e) {
        marker.setLatLng(e.latlng);
        updateLocation(e.latlng.lat, e.latlng.lng);
    });

    marker.on('dragend', function (e) {
        var latlng = e.target.getLatLng();
        updateLocation(latlng.lat, latlng.lng);
    });
</script>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // ✅ Ajax Form Submit
        $(document).ready(function() {

               $("form").on("submit", function (e) {
            e.preventDefault();

            const form = $(this);
            const formData = new FormData(this);

            // ✅ التحقق من مفروشات
            const isFurnished = $("#CanBeFurnished").is(":checked");
            const furnitureItems = $(".furniture-item");

            if (isFurnished && furnitureItems.length > 0) {
                let valid = true;
                let emptyItems = [];

                furnitureItems.each(function (index) {
                    const name = $(this).find("input[name*='Name']").val();
                    const price = $(this).find("input[name*='Price']").val();
                    const imageInput = $(this).find("input[name*='Image']")[0];
                    const image = imageInput ? imageInput.files[0] : null;

                    if (!name || !price || !image) {
                        valid = false;
                        emptyItems.push(index + 1);
                    }
                });

                if (!valid) {
                    Swal.fire({
                        icon: "warning",
                        title: "الرجاء تعبئة جميع بيانات الأثاث",
                        text: "تأكد من إدخال الاسم والسعر وصورة لكل قطعة أثاث قبل الحفظ"
                    });
                    return;
                }
            } else if (isFurnished && furnitureItems.length === 0) {
                Swal.fire({
                    icon: "info",
                    title: "يرجى إضافة أثاث",
                    text: "إذا كان العقار مفروش، يرجى إضافة قطع الأثاث المتاحة"
                });
                return;
            }

            // 🔄 بعد التحقق نعمل الـ AJAX
            $.ajax({
                url: form.attr("action"),
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                beforeSend: function () {
                    Swal.fire({
                        title: "جارٍ الحفظ...",
                        text: "يرجى الانتظار لحين إتمام العملية",
                        icon: "info",
                        allowOutsideClick: false,
                        showConfirmButton: false,
                        didOpen: () => Swal.showLoading()
                    });
                },
                success: function (response) {
                    Swal.close();
                    if (response.isSuccess) {
                        Swal.fire({
                            icon: "success",
                            title: "تم الحفظ بنجاح ✅",
                            text: response.message,
                            confirmButtonText: "موافق"
                        }).then(() => window.location.href = "/RealEstate/Index");
                    } else {
                        Swal.fire({
                            icon: "error",
                            title: "خطأ ❌",
                            text: response.message || "حدث خطأ أثناء الحفظ"
                        });
                    }
                },
                error: function (xhr) {
                    Swal.close();
                    Swal.fire({
                        icon: "error",
                        title: "خطأ في الخادم ❌",
                        text: "حدث خطأ أثناء الاتصال بالخادم"
                    });
                    console.error(xhr.responseText);
                }
            });
        });
        });
    </script>

    <script>
        const checkbox = document.getElementById("CanBeFurnished");
        const furnitureSection = document.getElementById("furnitureSection");
        const list = document.getElementById("furnitureList");
        const addBtn = document.getElementById("addFurnitureBtn");

        checkbox.addEventListener("change", () => {
            furnitureSection.style.display = checkbox.checked ? "block" : "none";
            if (checkbox.checked && list.children.length === 0) {
                // إضافة أول قطعة أثاث تلقائياً
                addFurnitureItem(0);
            }
        });

        let furnitureIndex = 0;
        
        function addFurnitureItem(index) {
            const item = document.createElement("div");
            item.classList.add("card", "p-3", "mb-3", "furniture-item", "shadow-sm", "border");
            item.innerHTML = `
                <div class="row g-3 align-items-start">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">اسم الأثاث</label>
                        <input type="text" name="Furnitures[${index}].Name" class="form-control" placeholder="مثلاً: تلفاز LED" required />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">السعر (جنيه)</label>
                        <input type="number" name="Furnitures[${index}].Price" class="form-control" placeholder="مثلاً: 5000" step="0.01" min="1" required />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">صورة الأثاث</label>
                        <input type="file" name="Furnitures[${index}].Image" accept="image/*" class="form-control furniture-image-input" required />
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-danger remove-furniture w-100" title="حذف">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12 text-center">
                        <img class="img-preview img-thumbnail" style="max-height:150px; max-width:200px; display:none; border: 2px solid #ddd; border-radius: 8px;" />
                    </div>
                </div>
            `;
            list.appendChild(item);
            furnitureIndex++;
        }

        addBtn.addEventListener("click", () => {
            addFurnitureItem(furnitureIndex);
        });

        list.addEventListener("click", e => {
            if (e.target.closest(".remove-furniture")) {
                e.target.closest(".furniture-item").remove();
                // إعادة ترقيم العناصر
                updateFurnitureIndexes();
            }
        });

        list.addEventListener("change", e => {
            if (e.target.classList.contains("furniture-image-input")) {
                const file = e.target.files[0];
                const img = e.target.closest(".furniture-item").querySelector(".img-preview");
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        img.src = e.target.result;
                        img.style.display = "block";
                    };
                    reader.readAsDataURL(file);
                } else {
                    img.style.display = "none";
                }
            }
        });

        function updateFurnitureIndexes() {
            const items = list.querySelectorAll(".furniture-item");
            items.forEach((item, index) => {
                item.querySelectorAll("input, select").forEach(input => {
                    if (input.name) {
                        input.name = input.name.replace(/Furnitures\[\d+\]/, `Furnitures[${index}]`);
                    }
                });
            });
            furnitureIndex = items.length;
        }

        // إذا كان checkbox محدد مسبقاً، أضف قطعة أثاث أولى
        if (checkbox.checked) {
            addFurnitureItem(0);
        }

        // تصميم رفع الصور
        const uploadBox = document.querySelector(".upload-box");
        const fileInput = document.getElementById("propertyImages");
        const previewContainer = document.getElementById("previewContainer");

        uploadBox.addEventListener("click", () => fileInput.click());
        fileInput.addEventListener("change", e => {
            previewContainer.innerHTML = "";
            [...e.target.files].forEach(file => {
                const reader = new FileReader();
                reader.onload = e2 => {
                    const img = document.createElement("img");
                    img.src = e2.target.result;
                    img.classList.add("img-thumbnail");
                    img.style.maxHeight = "120px";
                    previewContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        });
    </script>

    @await Html.PartialAsync("_ValidationScriptsPartial")
}
